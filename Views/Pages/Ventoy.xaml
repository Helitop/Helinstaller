<Page
    x:Class="Helinstaller.Views.Pages.Ventoy"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:local="clr-namespace:Helinstaller.BreachMiniGame"
    mc:Ignorable="d" Margin="0,15,0,0">
    <Page.Resources>
        <!-- Если понадобится, можно добавить конвертеры здесь -->
    </Page.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition/>
            <RowDefinition/>
        </Grid.RowDefinitions>
        <Grid Grid.Row="0">
        <Grid.ColumnDefinitions>
            <ColumnDefinition/>
            <ColumnDefinition/>
        </Grid.ColumnDefinitions>

        <!-- Левая колонка: USB и Ventoy -->
        <StackPanel Orientation="Vertical">
            <ui:Card>
                <StackPanel>
                    <ui:TextBlock Text="USB" FontTypography="Title" HorizontalAlignment="Center"/>
                    <ui:TextBlock Text="Выбор USB накопителя для установки Ventoy и использования его в качестве загрузочного устройства." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- COMBOBOX: привязка к списку USB накопителей -->
                        <ComboBox x:Name="DrivesListView" ItemsSource="{Binding UsbDrives}"
                                  SelectedItem="{Binding SelectedDrive, Mode=TwoWay}"
                                  DisplayMemberPath="DisplayName"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Center"
                                  Margin="0,0,5,0"/>

                        <!-- Кнопка обновить: внутри неё либо значок, либо ring -->
                        <ui:Button x:Name="RefreshButton" Grid.Column="1" Width="36" Height="36"
                                   IsEnabled="{Binding IsRefreshEnabled}"
                                   Click="RefreshButton_Click">
                        </ui:Button>
                        <Grid Grid.Column="1" Panel.ZIndex="-1">
                            <ui:SymbolIcon Symbol="ArrowClockwise48" Visibility="{Binding IconVisibility}"/>
                            <ui:ProgressRing Width="24" Height="24" IsIndeterminate="True" Visibility="{Binding RingVisibility}"/>
                        </Grid>
                    </Grid>

                    <!-- Прогресс форматирования/операции (например, для будущего использования) -->
                    <ProgressBar Margin="0,5,0,0" Minimum="0" Maximum="100" Value="{Binding SelectedDrive.UsedPercent, Mode=OneWay}"/>

                    <Grid Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>

                        <!-- Текст с информацией об устройстве -->
                        <ui:TextBlock Text="{Binding DeviceInfoText}" TextWrapping="Wrap"/>

                        <ui:Button Content="Форматировать" Grid.Column="1" HorizontalAlignment="Right"
                                   Click="FormatButton_Click"
                                   IsEnabled="{Binding CanFormat}"/>
                    </Grid>
                </StackPanel>
            </ui:Card>

            <ui:Card>
                <StackPanel>
                    <ui:TextBlock Text="Ventoy" FontTypography="Title" HorizontalAlignment="Center"/>
                    <ui:TextBlock Text="Форматирует флешку в качестве загрузочного диска и позволяет хранить и устанавливать несколько образов ОС. Намного проще чем Rufus." TextWrapping="Wrap" Margin="0,0,0,10"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <ui:Button x:Name="InstallButton" Content="Установить" Appearance="Primary" HorizontalAlignment="Center" Click="InstallButton_Click"/>
                        <ui:Button x:Name="UpdateButton" Content="Обновить" HorizontalAlignment="Center" Grid.Column="1" Click="UpdateButton_Click"/>
                    </Grid>
                </StackPanel>
            </ui:Card>
        </StackPanel>

        <!-- Правая колонка: Загрузка образа (без изменений привязок) -->
        <StackPanel Orientation="Vertical" Grid.Column="1">
            <ui:Card>
                <StackPanel>
                    <ui:TextBlock Text="Загрузка образа" FontTypography="Title" HorizontalAlignment="Center"/>
                    <Grid Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="auto"/>
                        </Grid.ColumnDefinitions>
                        <ComboBox x:Name="IsoBox" SelectionChanged="IsoBox_SelectionChanged" SelectedIndex="0">
                            <ComboBoxItem Name="local" Content="Локальный файл"/>
                            <ComboBoxItem Name="win11" Content="Windows 11" Tag="https://software-static.download.prss.microsoft.com/dbazure/888969d5-f34g-4e03-ac9d-1f9786c66749/26200.6584.250915-1905.25h2_ge_release_svc_refresh_CLIENT_CONSUMER_x64FRE_ru-ru.iso"/>
                            <ComboBoxItem Name="win10" Content="Windows 10" Tag="https://drive.massgrave.dev/ru-ru_windows_10_consumer_editions_version_22h2_updated_oct_2025_x64_dvd_38efd00d.iso"/>
                            <ComboBoxItem Name="win11ltsc" Content="Windows 11 LTSC" Tag="https://drive.massgrave.dev/en-us_windows_11_iot_enterprise_ltsc_2024_x64_dvd_f6b14814.iso"/>
                            <ComboBoxItem Name="win10ltsc" Content="Windows 10 LTSC" Tag="https://drive.massgrave.dev/en-us_windows_10_iot_enterprise_ltsc_2021_x64_dvd_257ad90f.iso"/>
                        </ComboBox>
                    </Grid>
                    <Grid Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBox x:Name="LocalFilePathTextBox" PlaceholderText="Путь к файлу образа .iso" Margin="0,0,5,0"/>
                        <ui:Button x:Name="Browse" Content="Обзор" Grid.Column="1" Click="BrowseButton_Click" />
                    </Grid>
                    <ProgressBar x:Name="progressBar" Margin="0,5,0,0"/>
                    <ui:TextBlock x:Name="isoText" HorizontalAlignment="Center"/>
                    <Grid Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition Width="auto"/>
                        </Grid.ColumnDefinitions>

                        <ui:Button x:Name="DownloadButton" Content="Загрузить"
               Appearance="Primary"
               HorizontalAlignment="Stretch"
               Margin="0,0,5,0"
               Click="DownloadButton_Click"/>

                        <ui:Button x:Name="CancelButton"
               Content="Отмена"
               Appearance="Secondary"
               HorizontalAlignment="Right"
               Grid.Column="1"
               Click="CancelButton_Click"
               IsEnabled="False"/>
                    </Grid>
                </StackPanel>

            </ui:Card>
                <ui:Card>
                    <StackPanel>
                        <ui:TextBlock Text="Установленные образы" FontTypography="Title" HorizontalAlignment="Center"/>
                        
                        <ui:ListView x:Name="ImagesList" ItemsSource="{Binding FoundIsoImages}" 
          Height="150"
          ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListView.Style>
                                <Style TargetType="ui:ListView" BasedOn="{StaticResource {x:Type ui:ListView}}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FoundIsoImages.Count}" Value="0">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate>
                                                        <Grid>
                                                            <TextBlock Text="Образы ISO/IMG не найдены." HorizontalAlignment="Center" VerticalAlignment="Center" 
                                                   FontStyle="Italic" Foreground="Gray"/>
                                                        </Grid>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ListView.Style>
                            <ui:ListView.ItemContainerStyle>
                                <Style TargetType="ui:ListViewItem" 
               BasedOn="{StaticResource {x:Type ui:ListViewItem}}">
                                    <Setter Property="Margin" Value="0,2"/>
                                </Style>
                            </ui:ListView.ItemContainerStyle>

                            <ui:ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <ui:TextBlock Text="{Binding FileName}"
                                        ToolTip="{Binding FullPath}"
                                        Margin="5,0"/>
                                        <ui:TextBlock HorizontalAlignment="Right" Text="{Binding Size}"/>
                                    </Grid>
                                </DataTemplate>
                            </ui:ListView.ItemTemplate>
                        </ui:ListView>
                        <Grid HorizontalAlignment="Stretch" VerticalAlignment="Bottom">
                            <ui:Button Content="Сконфигурировать установщик" 
                                       HorizontalAlignment="Left"
           Appearance="Primary" 
           Icon="Wrench24"
           Margin="0,0,5,0"
           Click="InjectOnlyButton_Click"
           ToolTip="Сконфигурировать установщик вручную"/>
                            <ui:Button HorizontalAlignment="Right" Click="Button_Click_1">
                                <ui:SymbolIcon Symbol="Delete48"/>
                            </ui:Button>
                        </Grid>
                    </StackPanel>
                </ui:Card>
        </StackPanel>
    </Grid>
        <ui:Card Margin="0,100,0,0" Width="1000" Height="800" Grid.Row="1">
            <Grid>
                <ui:Button x:Name="HackButton" Content="Начать взлом..." Appearance="Secondary" HorizontalAlignment="Center" VerticalAlignment="Center" Visibility="Visible" Click="Button_Click"/>
                <local:CyberBreachProtocolControl x:Name="HackMenu" Visibility="Hidden"/>
            </Grid>
        </ui:Card>
    </Grid>
</Page>
